# Get Start

## 介绍

* 介绍: 静态web服务器
* 用途
  * 反向代理
  * 负载均衡
  * 微服务
  * API网关
  * 邮件代理!
  * HTTP缓存

* 历史

  * 2004年由[Igor Sysoev](https://en.wikipedia.org/wiki/Igor_Sysoev)创建
  * 2011年,同名公司创建, 提供Nginx Plus付费软件
  * 2019年,该公司被Netcraft收购

  > 尽管Nginx Plus是付费软件, 但Nginx仍是发布在类BSD许可下的开源免费软件.

* 特性

  * 使用异步事件驱动机制, 而非多线程来处理请求, 能够提供更好的负载能力.

    > 不是说异步事件驱动就不会使用多线程处理请求, 仅是从请求到来时, 如何处理请求这个方式来区分的.

  * 可以和其他CGI应用组合, 服务动态网页
  
  * ...

## 使用

* 组成

  * 一个主进程: 读取和evaluate配置和维护工作进程
  * 多个工作进程: 处理请求的地方

  > 基于事件驱动模型来分发请求, 这个功能谁来干? 不知道...

* 安装(for Ubuntu)

  * 安装前准备必要命令

    ```bash
    sudo apt install curl gnupg2 ca-certificates lsb-release
    ```

  * 设置nginx的apt仓库

    * 使用稳定版本nginx的仓库

        ```bash
        echo "deb http://nginx.org/packages/ubuntu `lsb_release -cs` nginx" | sudo tee /etc/apt/sources.list.d/nginx.list
        ```
        
    * 使用主线版本nginx的仓库

        ```bash
        echo "deb http://nginx.org/packages/mainline/ubuntu `lsb_release -cs` nginx" | sudo tee /etc/apt/sources.list.d/nginx.list
        ```

  * 导入nginx的签名密钥, 校验仓库的可靠性

    ```bash
    curl -fsSL https://nginx.org/keys/nginx_signing.key | sudo apt-key add -
    ```

  * 从nginx仓库中安装软件

    ```bash
    sudo apt update && sudo apt install nginx
    ```

* 管理

  * `nginx`启动

  * `nginx -s stop`快速关闭

  * `nginx -s quit`完整关闭

    > 其他的关闭方法:
    >
    > `kill -s QUIT 1628`, 进程号可从pid文件中获取
    >
    > 使用`QUIT`, 主线程就会去关闭工作线程. 最好不要用`KILL`

  * `nginx -t` 不运行, 仅测试配置文件

  * `nginx -s reload`重载配置

    > 修改配置后需要手动加载.
    >
    > 加载原理: 主线程解析配置, 成功则通知老工作线程做扫尾工作, 并开启新工作进程. 否则仍使用老配置

  * `nginx -s reopen`重开日记文件

  * `ps aux|grep nginx`查看所有nginx进程

* 文件
  * 日志目录`/usr/local/nginx/logs` 或 `/var/log/nginx`.
  * 配置文件`/etc/nginx/nginx.conf`

# 基础

> 配置位于`/etc/nginx.conf`文件中

## 语法

配置由指令和注解组成, 指令可分为

* 简单指令

  * 由名字和参数组成

  * 多个参数以空格分割

  * 指令以`;`结束

  * 例子

    ```bash
    pid        /var/run/nginx.pid;
    ```

* 块指令

  * 与简单指令结构类似

  * 指令内容被包裹在`{}`之内, 里面可以有其他简单指令或块指令

  * 块指令构成了一个上下文`context`, 用于归类配置

  * 最外层的指令默认处于`main`上下文中

  * 例子

    ```bash
    http {
        include       /etc/nginx/mime.types;
        default_type  application/octet-stream;
    
        log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                          '$status $body_bytes_sent "$http_referer" '
                          '"$http_user_agent" "$http_x_forwarded_for"';
    
        access_log  /var/log/nginx/access.log  main;
    
        sendfile        on;
        #tcp_nopush     on;
    
        keepalive_timeout  65;
    
        #gzip  on;
    
        include /etc/nginx/conf.d/*.conf;
    }
    ```

* 注解: 以`#`开始的行为注解

> 注意, 指令的语义可以含有继承关系

## 文件结构

```
...#全局块

events {events块
   ...
}

http #http块
{
    ...#http全局块
    server#server块
    { 
        ... #server全局块
        location [PATTERN] #location块
        {
            ...
        }
        location [PATTERN] 
        {
            ...
        }
    }
    server
    {
      ...
    }
    ...  #http全局块
}
```

- **全局块**：配置影响nginx全局的指令。一般有运行nginx服务器的用户组，nginx进程pid存放路径，日志存放路径，配置文件引入，允许生成worker process数等。
- **events块**：配置影响nginx服务器或与用户的网络连接。有每个进程的最大连接数，选取哪种事件驱动模型处理连接请求，是否允许同时接受多个网路连接，开启多个网络连接序列化等。
- **http块**：可以嵌套多个server，配置代理，缓存，日志定义等绝大多数功能和第三方模块的配置。如文件引入，mime-type定义，日志自定义，是否使用sendfile传输文件，连接超时时间，单连接请求数等。
- **server块**：配置虚拟主机的相关参数，一个http中可以有多个server。
- **location块**：配置请求的路由，以及各种页面的处理情况。

## 默认配置解读

```nginx
##
# You should look at the following URL's in order to grasp a solid understanding
# of Nginx configuration files in order to fully unleash the power of Nginx.
# https://www.nginx.com/resources/wiki/start/
# https://www.nginx.com/resources/wiki/start/topics/tutorials/config_pitfalls/
# https://wiki.debian.org/Nginx/DirectoryStructure
#
# In most cases, administrators will remove this file from sites-enabled/ and
# leave it as reference inside of sites-available where it will continue to be
# updated by the nginx packaging team.
#
# This file will automatically load configuration files provided by other
# applications, such as Drupal or Wordpress. These applications will be made
# available underneath a path with that package name, such as /drupal8.
#
# Please see /usr/share/doc/nginx-doc/examples/ for more detailed examples.
##

# Default server configuration
#
server {
	listen 80 default_server;
	listen [::]:80 default_server;

	# SSL configuration
	#
	# listen 443 ssl default_server;
	# listen [::]:443 ssl default_server;
	#
	# Note: You should disable gzip for SSL traffic.
	# See: https://bugs.debian.org/773332
	#
	# Read up on ssl_ciphers to ensure a secure configuration.
	# See: https://bugs.debian.org/765782
	#
	# Self signed certs generated by the ssl-cert package
	# Don't use them in a production server!
	#
	# include snippets/snakeoil.conf;

	root /root/Blog/root/web;

	# Add index.php to the list if you are using PHP
	index index.html index.htm index.nginx-debian.html;

	server_name _;

	location / {
		# First attempt to serve request as file, then
		# as directory, then fall back to displaying a 404.
		try_files $uri $uri/ =404;
	}

	# pass PHP scripts to FastCGI server
	#
	#location ~ \.php$ {
	#	include snippets/fastcgi-php.conf;
	#
	#	# With php-fpm (or other unix sockets):
	#	fastcgi_pass unix:/var/run/php/php7.0-fpm.sock;
	#	# With php-cgi (or other tcp sockets):
	#	fastcgi_pass 127.0.0.1:9000;
	#}

	# deny access to .htaccess files, if Apache's document root
	# concurs with nginx's one
	#
	#location ~ /\.ht {
	#	deny all;
	#}
}


# Virtual Host configuration for example.com
#
# You can move that to a different file under sites-available/ and symlink that
# to sites-enabled/ to enable it.
#
#server {
#	listen 80;
#	listen [::]:80;
#
#	server_name example.com;
#
#	root /var/www/example.com;
#	index index.html;
#
#	location / {
#		try_files $uri $uri/ =404;
#	}
#}

```



# Web Server

## 介绍

配置一个Web Server, 就是配置URL如何被处理. 

首先, Http中URL的简化结构如下:

```url
(http|https)://host[:port][path]
```

在Nginx中, 以`host`和`port`确定**Virtual Server**, 以`path`确定`Location`.

`Virtual Server`中含有与Server相关的配置; `Location`确定`path`与访问资源的映射关系, 可以是本地文件或代理服务器(反向代理).

## Virtual Server

* 介绍

  不同的域名或IP的请求被不同的Virtual Server处理

* 结构

    ```nginx
    http {
        server {
            # Server configuration
        }
    }
    ```
    
    > `http`中`server`可有多个
    
* 配置

    * `listen` 设置监听端口和IP

      ```nginx
      server {
          listen 127.0.0.1:8080;
          # The rest of server configuration
      }
      ```

      > IP可省略, 默认所有地址; 端口可省略, nginx有管理员权限时默认`80`端口, 否则`8000`端口

    * `server_name` 设置监听的域名

      ```nginx
      server {
          listen      80;
          server_name example.org www.example.org;
          #...
      }
      ```

      > 可省略, 默认所有域名.

      有三种形式指定域名: 完整域名, 含通配符, 正则. 

      > 其中, 通配符只能位于域名前,后或两端都有
      >
      > ```nginx
      > server {
      >     server_name example.com *.example.com www.example.*;
      > }
      > ```
      >
      > 正则需加前缀`~`
      >
      > ```nginx
      > server {
      >     server_name www.example.com ~^www\d+\.example\.com$;
      > }
      > ```

    * 默认Server

      默认以第一个`server`指令为默认Server. 可通过`listen`的`default_server`参数显式指定, 如:

      ```nginx
      server {
          listen 80 default_server;
          #...
      }
      ```

* 路由规则

    当请求到来时

    1. 找出IP和端口一致的`server`

    2. 再将请求的`Host`与`server_name`比较, 成功匹配则使用该Virtual Server, 否则使用默认Server

## Location

* 介绍

  映射请求到具体的资源上.

* 语法

  ```nginx
  Syntax:	location [ = | ~ | ~* | ^~ ] uri { ... }
  Default:	—
  Context:	server, location
  ```

* 匹配模式

  有多种匹配方式, 其中后缀匹配可以使用正则.

  * 空: 前缀匹配

    ```nginx
    location /some/path/ {
        #...
    }
    ```

    > 将匹配`/some/path/document.html`

  * `~`: 使用正则进行后缀匹配, 大小写敏感

    ```nginx
    location ~ \.html? {
        #...
    }
    ```

    > 将匹配以`.html`或`.htm`结尾的路径

  * `~*`: 使用正则进行后缀匹配, 大小写不敏感

  * `^~` 前缀匹配, 若匹配成功, 且该前缀最长时, 将不进行后缀匹配过程.

    > 即影响下面的匹配规则

  * `=`: 准确匹配, 同样也无后缀匹配过程

    ```nginx
    location = / {
        #...
    }
    ```

* 匹配规则

  当`server`收到请求时

  1. 先前缀匹配  选择并记住前缀最长的`location`

  2. 再匹配后缀, 选中第一个成功匹配的后缀并**结束**, 使用该`location`的配置

  3. 如果后缀匹配不成功, 则使用之前记住的最长前缀的`location`配置

  > 注意, 前缀匹配过程中,  `=`和`^~`(需满足条件: 前缀最长) 无后缀匹配过程

* 资源映射

  ```nginx
  server {
      location /images/ {
          root /data;
      }
  
      location / {
          proxy_pass http://www.example.com;
      }
  }
  ```
  
  `root`确定URL路径和系统路径的映射关系, 文件的真实路径=系统路径+URL路径.
  
  > 如请求路径`/images/example.png`, 访问的文件路径则为`/data/images/example.png`
  
  `proxy_pass`确定URL路径和代理Server的关系, 资源位置=代理URL+URL路径
  
  > 如请求路径`/videos/hello.mp4`, 访问的文件路径则为`http://www.example.com/videos/hello.mp4`

## 其他

### 重写URL

### 修改响应

# HTTPS











# 其他

## 变量

nginx中可以定义变量, 也提供了代表请求头字段的变量.

> 见[Embedded Variables](https://nginx.org/en/docs/http/ngx_http_core_module.html?&_ga=2.36392416.114713352.1578467350-2037701528.1578467350#variables)

## 踩坑

### 403 forbidden

403说明我们的访问受限, 很多种原因都可造成403, 这里只谈及我遇到的.

原因:

虽然我们是通过`root`用户运行的Nginx, 但是在它的配置文件中, 指定了工作进程使用`nginx`用户来运行. 因此不能访问`root`用户的文件.

解决方案:

1. 在配置文件中指定工作进程以`root`身份运行, 但不安全
2. 改变文件所属者为`nginx`, 给与目录访问权限即可. (推荐)

> 参考:[Nginx出现403 forbidden](https://blog.csdn.net/qq_35843543/article/details/81561240)

# 参考

* [所有指令](http://nginx.org/en/docs/http/ngx_http_core_module.html)
* [Web Server](https://docs.nginx.com/nginx/admin-guide/web-server/web-server/) Nginx Plus的文档, 讲的比较细











